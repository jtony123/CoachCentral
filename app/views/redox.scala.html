@import be.objectify.deadbolt.java.views.html.{restrict, restrictOr}
@import be.objectify.deadbolt.java.utils.TemplateUtils.{allOf, anyOf, allOfGroup}
@import tags._
@(user : models.User, active: String, player: models.Player, playerIndex: Integer, players: List[models.Player], category:String, categories: List[models.Category])


@main(title = "CoachCentral") {
    
      <div class="container-fluid" id="outer_container" style="background-color: #FBFBFB">
    @navigationbar(user: models.User, active: String)
    
        <style> 
#player_icon {
  position: relative;
  perspective: 1000;
}
#player_icon_card {
  width: 100%;
  height: 100%;
/*   transform-style: preserve-3d; */
  
/*    -webkit-animation-name: player_icon_flip; */
/*     -webkit-animation-duration: 2s;  */
/*     animation-name: player_icon_flip; */
/*     animation-duration: 12s; */
/*      animation-delay: 2s; */

/*     animation-iteration-count: 2; */
  
}
@@-webkit-keyframes player_icon_flip {
	10% { transform: rotateY(180deg);}
	20% { transform: rotateY(0deg);}
	60% { transform: rotateY(0deg);}
	70% { transform: rotateY(180deg);}
	80% { transform: rotateY(0deg);}
}
#player_icon:hover #player_icon_card {
-webkit-animation: none;
/*   transform: rotateY(180deg); */
  box-shadow: -5px 5px 5px #aaa;
}
.face {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
}
.face.back {
  display: block;
  transform: rotateY(180deg);
  box-sizing: border-box;
  color: red;
  text-align: center;
  background-color: #aaa;
}
</style>

<div class="container-fluid" id="groupings_toggle_buttons">
	<div>
	@for(c <- categories) {
		@if(c.name.equals(category)){
		<a href="@routes.Application.redox(player.playernumber, c.name)" class="badge active" style="background-color: white;"><span class="badge" style=" color: #337ab7; background-color:yellow;">@c.name</span></a>
		} else {
		<a href="@routes.Application.redox(player.playernumber, c.name)" class="badge" style="background-color: white;"><span class="badge" style=" color: #337ab7; background-color: white;">@c.name</span></a>
   		}
	}
	</div>
</div>

<div class="row" id ="player_carousel">
	  <div class="col-xs-5 col-sm-5 col-md-5 col-lg-5"><p class="text-center">
	  
	  <div class="btn-group btn-group-justified">
	  
	   @if(players.size() > 5){
	   
	   <a href='@routes.Application.redox(players.get(Math.floorMod((playerIndex - 4), players.size())).playernumber, category)' class="btn btn-default"  class="thumbnail" style="margin-bottom: 0px; border:none;">
						<div >
					
						</div>
						<div class="text-nowrap" style="text-align: center;">
							<<
						</div>
					</a>
	   }
	   
	  
	  @if(players.size() > 5){
	  
	  		@player_icon(players.get(Math.floorMod((playerIndex - 3), players.size())), category, active)
	  		
	  }
	  
	  @if(players.size() > 3){
	  		@player_icon(players.get(Math.floorMod((playerIndex - 2), players.size())), category, active)
	  }
	  
	  @if(players.size() > 1){
	  		@player_icon(players.get(Math.floorMod((playerIndex - 1), players.size())), category, active)
	  }
	
	  </div>
	  </div>
	  
	  
	  
	  <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2" id="player_icon">
	  	<div id="player_icon_card">
	  		<div class="front face">
	  		
	  			<h4 style="margin-bottom: 5px; margin-top:5px;">
	  			
	  			@restrict(roles = allOfGroup("redoxtester")) {
					<a href="@routes.Application.record(player.playernumber, category)" class="thumbnail" style="margin-bottom: 0px;">
				}
						
						<div>
						
						@if(player.playerPhoto != null){
							<img class="img-responsive" src="@routes.Application.playerPhoto(player.id)" alt="" style="margin: 0 auto; max-width:150px;height:150px"/>
						} else {
							<img class="img-responsive" src='@routes.Assets.at("images/player-headshot.png")' alt="" style="margin: 0 auto; max-width:150px;height:150px;"/>
						}
						
						</div>
						<div class="text-nowrap" style="text-align: center;">
							@player.playername
						</div>
					
					@restrict(roles = allOfGroup("redoxtester")) {
					</a>
					
					}
				</h4>
			</div> <!-- end front face -->
			

			
			
			</div>
	  </div>
	  
	  
	  <div class="col-xs-5 col-sm-5 col-md-5 col-lg-5"><p class="text-center"></p>
	 
	 	<div class="btn-group btn-group-justified">
	 		
	 @if(players.size() > 2){
	 	@player_icon(players.get(Math.floorMod((playerIndex + 1), players.size())), category, active)
	 }
	 
	  @if(players.size() > 4){
	  	@player_icon(players.get(Math.floorMod((playerIndex + 2), players.size())), category, active)
	 }
	 
	  @if(players.size() > 6){
	  	@player_icon(players.get(Math.floorMod((playerIndex + 3), players.size())), category, active)
	 }
	 
	  @if(players.size() > 6){
	 		<a href='@routes.Application.redox(players.get(Math.floorMod((playerIndex + 4), players.size())).playernumber, category)' class="btn btn-default" class="thumbnail" style="margin-bottom: 0px;  border:none;">
					
			<div class="text-nowrap" style="text-align: center;">
				>>
				
			</div>		
			</a>
	 }
	 	</div>
	 	
	  </div>
	  
	  
</div><!-- end div player carousel -->

<!-- the panel below the pagination carousel -->
	
<div class="chart" class="container-fluid" id="main_chart"  style="border:1px solid #cecece; border-radius: 20px;
																	margin:20px;
																	background-color: white;
																	box-shadow: 0px 0px 10px grey;">
	<div class="chart_upper" class="row" id="chart_upper" >
	<br><br>
	</div>
	<div class="chart_centre" class="row" id="chart_centre">
	
	<svg id="redoxsvg" style="display: block;"></svg>
	
	
	<div class="row rdxviewrow" style="padding-top: 0px; padding-bottom:0px;"> <!-- row with diet training load and sleep icons -->
	
		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="text-align:right;">
			<svg id="dietsvg"  x="0px" y="0px" width="15%" viewBox="30 30 90 90">
				<style type="text/css">
					.stdiet0{fill-rule:evenodd;clip-rule:evenodd;fill:lightgrey;}
					.stdiet1{fill-rule:evenodd;clip-rule:evenodd;fill:#4CC7DE;}
					
				</style>
				<g>
					<path class="stdiet0" d="M97,114.1H49.2c-1.4,0-2.5-1.1-2.5-2.5v0c0-1.4,1.1-2.5,2.5-2.5H97c1.4,0,2.5,1.1,2.5,2.5v0
						C99.6,113,98.4,114.1,97,114.1z"/>
					<path class="stdiet0" d="M107.3,70.1H38.9c-1.4,0-2.6,1.2-2.5,2.6c1.3,19.1,17.2,34.1,36.6,34.1s35.3-15.1,36.6-34.1
						C109.9,71.3,108.7,70.1,107.3,70.1z M76.4,100.5l0.1-10.5c6.4-0.6,10.7-5.5,10.7-11.4l12.4,0.1C99.5,90.4,89.6,99.9,76.4,100.5z"/>
					<path class="stdiet0" d="M73.2,91.1l16.4-43c0.2-0.6,1-1,1.6-0.7h0c0.6,0.2,1,1,0.7,1.6L75.5,92c-0.2,0.6-1,1-1.6,0.7l0,0
						C73.3,92.5,73,91.8,73.2,91.1z"/>
					<path class="stdiet0" d="M73.5,82.3l39.3-39.3c0.5-0.5,1.3-0.5,1.8,0l0.3,0.3c0.5,0.5,0.5,1.3,0,1.8L75.6,84.4c-0.5,0.5-1.3,0.5-1.8,0
						l-0.3-0.3C73,83.7,73,82.8,73.5,82.3z"/>
				</g>
			</svg>
		</div>
		
		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="text-align:center;">
			<svg id="trainloadsvg" x="0px" y="0px" width="15%" viewBox="30 30 90 90">
				<style type="text/css">
					.sttrain00{fill:lightgrey;stroke:lightgrey;stroke-miterlimit:10;}
					.sttrain01{fill:#4CC7DE;stroke:#4CC7DE;stroke-miterlimit:10;}
/* 					.sttrain10{fill:lightgrey;} */
/* 					.sttrain11{fill:#4CC7DE;} */
				</style>
				<path class="sttrain10" d="M42,109c0,0,16.9-19,31.3-16s5,14,20.4,8s18.4,8,18.4,8"/>
				<g>
					<path class="sttrain10" d="M47.9,76h-5.6c-2.1,0-3.8,1.9-3.8,4.3V91v5.2v19.2h13.3V96.1v-5.2V80.2C51.8,77.9,50.1,76,47.9,76z"/>
					<path class="sttrain10" d="M68.1,46.8h-5.5c-2.1,0-3.9,1.9-3.9,4.3v15v25.5v23.6H72V91.7V66.1v-15C72,48.7,70.2,46.8,68.1,46.8z"/>
					<path class="sttrain10" d="M87.2,71.4h-5.6c-2.1,0-3.8,1.9-3.8,4.3v9.8v6.1v23.7h13.3V91.6v-6.1v-9.8C91.1,73.3,89.4,71.4,87.2,71.4z"/>
					<path class="sttrain10" d="M107.4,83.6h-5.6c-2.1,0-3.8,1.9-3.8,4.3v3v12.9v11.5h13.3v-11.5V90.9v-3C111.3,85.5,109.6,83.6,107.4,83.6z"/>
				</g>
			</svg>
		</div>
		
		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" style="text-align:left;">
			<svg id="sleepsvg"  x="0px" y="0px" width="15%" viewBox="30 30 90 90">
			<style type="text/css">
				.stsleep0{fill:lightgrey;}
				.stsleep1{fill:#4CC7DE;}
			</style>
			<g>
				<path class="stsleep0" d="M75.8,98.4C62.9,98.4,52.4,88,52.4,75c0-7.4,3.5-14.1,8.9-18.3c-14.5,1.8-25.8,14.2-25.8,29.2
					c0,16.3,13.2,29.4,29.4,29.4c15,0,27.4-11.3,29.2-25.8C89.8,95,83.2,98.4,75.8,98.4z"/>
				<polygon class="stsleep0" points="94.8,47.7 99.1,44.5 93.7,44.5 91.9,39 90.2,44.5 84.8,44.5 89.1,47.7 87.2,53.3 91.9,49.8 96.7,53.3 
						"/>
				<polygon class="stsleep0" points="72.1,43.3 74.2,41.7 71.5,41.7 70.6,39 69.7,41.7 67.1,41.7 69.2,43.3 68.3,46.2 70.6,44.4 73,46.2 	
					"/>
				<polygon class="stsleep0" points="52.5,44.8 53.6,44 52.2,44 51.8,42.6 51.3,44 50,44 51.1,44.8 50.6,46.2 51.8,45.3 52.9,46.2 	"/>
				<polygon class="stsleep0" points="114.1,71.4 120.5,66.6 112.5,66.6 109.8,58.4 107.1,66.6 99.1,66.6 105.5,71.4 102.7,79.9 109.8,74.6 
					116.9,79.9 	"/>
			</g>
		</svg>

		</div>
	</div> <!-- end row with diet training load and sleep icons-->
	
	
	
	<div class="row rdxviewrow"> <!-- results show row  -->
	
		<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
			<div class="resultsshow">
					RESULTS SHOW
			</div>
		</div>
		
		<div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
			<div>				
				<img class="img-responsive orrecobullet"  src='@routes.Assets.at("images/favicon.ico")' alt=""/>
			</div>
		</div>
		
		<div class="col-xs-9 col-sm-9 col-md-9 col-lg-9">
			<div class="resultstext" id="RESULTSHOW">
			</div>
		</div>
	
	
	</div> <!-- end results show row -->
	
	
	<div class="row rdxviewrow"> <!-- potential outcomes row  -->
	
		<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
			<div class="potentialoutcomes">
					POTENTIAL OUTCOMES
			</div>
		</div>
		
		<div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
			<div>				
				<img class="img-responsive orrecobullet"  src='@routes.Assets.at("images/favicon.ico")' alt=""/>
			</div>
		</div>
		
		<div class="col-xs-9 col-sm-9 col-md-9 col-lg-9">
			
			<div class="potentialoutcomes" id="POTOUTS">
			</div>
		</div>
	
	</div> <!-- end potential outcomes row -->
	
	
	
	
	<div class="row rdxviewrow"> <!-- actions row  -->
	
			<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
			<div class="potentialoutcomes">
					ACTIONS
			</div>
		</div>
		
		<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10" id="ACTIONS">
			<!-- the content here is populated by js below -->
		</div>
		
	</div> <!-- end actions row -->
	
	
	
	<div class="row rdxviewrow"> <!-- scientist comments row  -->
	
	<div id="scientistcomment">
		<div class="row rdxcommentrow">
			<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
				<div class="potentialoutcomes">
						Dr. AN Other
				</div>
			</div>
			<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 rdxcomment" id="">
				This is a comment
			</div>
		</div>
		
		<div class="row rdxcommentrow">
			<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
				<div class="potentialoutcomes">
						Dr. AN Other
				</div>
			</div>
			
			<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 rdxcomment" id="">
				This is another comment
			</div>
		</div>
	</div>

	@restrict(roles = allOfGroup("redoxcomment")) {
		<div class="row rdxviewrow">
			<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
			@user.userName
			</div>
			<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 rdxcomment" id="">
				<form id='rdxcomment' action='@routes.Application.saveComment(player.playernumber, category)' method='POST'>
					<input type="text" name="comment" placeholder="...comments..." size="100">
					<input id="rdxid" type="hidden" name="rdxid" value="">
					<input type="hidden" name="ssname" value="@user.userName"><button>Post</button>
				</form>
			</div>
		</div>
	}
	
	</div> <!-- end scientist comments row -->
	
	
	<div class="row rdxviewrow"> <!-- eaten trained ill injury alert row  -->
	
	
	
		<div class="col-xs-8 col-sm-8 col-md-8 col-lg-8" style="border-right: 2px solid lightgrey;">
		
			<div class="row" style="border-bottom: 2px solid lightgrey;">
				<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
				
							
							<div id="EATEN">
								FASTED
							</div>
							<div id="EATENVALUE">
							</div>
						
				</div>
				
				<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
							
							<div id="TRAINED">
								RESTED
							</div>
							<div id="TRAINEDVALUE">
							</div>
						
				</div>
				
				<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
								
								<div id="ENERGY">
									ENERGY
								</div>
								<div id="NRGVALUE" style="float: left;">
								<svg id="nrgsvg"></svg>
								</div>
				</div>
			
				<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
								
								<div id="MUSCLE_SORENESS">
									MUSCLE SORENESS
								</div>
								<div id="MUSCSOREVALUE" style="float: left;">
								<svg id="muscsvg"></svg>
								</div>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
					<div class=""  id="SYMPTOMS" style="min-height: 40px;">
						SYMPTOMS
						
							<div class="testauto" id="FEVERSURROUND">
								<div class="anssubheadings" id="FEVER">
								</div>
								<div class="anssubheadingsright"  id="FEVERVALUE">
								</div>
							</div>
							<div class="testauto" id="COLDSORESURROUND">
								<div class="anssubheadings" id="COLDSORE">
								</div>
								<div class="anssubheadingsright"  id="COLDSOREVALUE">
								</div>
							</div>
							<div class="testauto" id="HEADACHESURROUND">
								<div class="anssubheadings" id="HEADACHE">
								</div>
								<div class="anssubheadingsright"  id="HEADACHEVALUE">
								</div>
							</div>
							<div class="testauto" id="JMACHESURROUND">
								<div class="anssubheadings" id="JMACHE">
								</div>
								<div class="anssubheadingsright" id="JMACHEVALUE">
								</div>
							</div>
							<div class="testauto" id="DIARRHEASURROUND">
								<div class="anssubheadings" id="DIARRHEA">
								</div>
								<div class="anssubheadingsright" id="DIARRHEAVALUE">
								</div>
							</div>
							<div class="testauto" id="OTHERSURROUND">
								<div class="anssubheadings" id="OTHER">
								</div>
								<div class="anssubheadingsright" id="OTHERVALUE">
								</div>
							</div>
						
					</div>
				</div>
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
						
					<div class=""  id="EXERCISE">
						Previous Day Activity
						<div>
							<div class="anssubheadings"  id="ACTIVITIESVALUE">
							</div>
						</div>
					</div>
				</div>
				
			
			</div>
			
			
			
		</div> <!-- end 8 cols -->
		
		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
		
			<div class="row" style="border-bottom: 2px solid lightgrey;">
	
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<div id="ILL">
									Reported Illness
								</div>
								<div id="ILLVALUE">
								</div>
				</div>
				
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
									<div id="INJURED">
										Reported Injury
									</div>
									<div id="INJUREDVALUE">
									</div>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<div class="">
						Tester Notes
						<div>
							
							<div class="anssubheadingsright"  id="TESTERNOTESVALUE">
							</div>
						</div>
					</div>
				</div>
			
			</div>
			
			
		</div>
		
		
		
		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
		

		
		</div>
	
	
	</div> <!-- end eaten trained ill injury alert row -->
	

	
	
	
	</div> <!-- end chart centre -->
	
	<div class="chart_lower" class="row" id="chart_lower">
		

</div> <!-- end chart lower -->



</div><!-- end  outer container-->



<script src="@routes.Assets.at("javascripts/ChartHelperMethods.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/TooltipTables.js")" type="text/javascript"></script>
<script>

var RDXview_state = true;


var jan2016 = new Date(2015, 11, 20);
var apr2016 = new Date(2016, 3, 1);
var fourMonthsahead = new Date(Date.now() + 120*24*3600*1000);
var threeweeksago = new Date(Date.now() + -21*24*3600*1000);
var oneweekahead = new Date(Date.now() + 7*24*3600*1000);
var xl = threeweeksago, xr = oneweekahead;
var rdxval = -1;

checkcookie();


var amberzone = 0.1;

////Adds the svg canvas
var windowHeight = window.innerHeight|| e.clientHeight|| g.clientHeight;

var windowwidth = parseInt(d3.select('#main_chart').style('width'), 10);
var mainchartborder = parseInt(d3.select('#main_chart').style('border'), 10);


var max_rdxsvg_h = 450;
var min_rdxsvg_h = 140;


var	redoxpane_h_open = Math.max(((windowHeight/8)), max_rdxsvg_h);
var redoxpane_h_closed = min_rdxsvg_h;



var redoxsvg = d3.select("#redoxsvg").attr("width", windowwidth - (2*mainchartborder)).attr("height", redoxpane_h_open);


var margins = {top: 140, right: 20, bottom:0, left: 20};
var width = +redoxsvg.attr("width") - margins.left - margins.right;

var height = +redoxsvg.attr("height") - margins.top - margins.bottom;
var ctx_height = 40;


var nrgsvg = d3.select("#nrgsvg").attr("width", 100).attr("height", 20);
var muscsvg = d3.select("#muscsvg").attr("width", 100).attr("height", 20);





var xfocus = d3.scaleTime().range([0, width]),
	yfocus2 = d3.scaleLinear().range([height, 0]);

var xcontext = d3.scaleTime().range([0, width]),
	ycontext = d3.scaleLinear().range([ctx_height, 0]);

var xAxis = d3.axisBottom(xfocus);
var xAxis2 = d3.axisTop(xcontext).tickArguments([d3.timeMonth]);
var yAxisRdx = d3.axisLeft(yfocus2).tickArguments([5, "s"]).tickSize(-width, 0, 0).tickPadding([-25]);

var brush = d3.brushX()
.extent([[0, 0], [width, ctx_height]])
.on("brush end", brushed);

var zoom = d3.zoom()
.scaleExtent([2, 300])
.translateExtent([[0, 0], [width, height]])
.extent([[0, 0], [width, height]])
.on("zoom", zoomed);

var rdxtooltip = d3.select("body").append("div")   
.attr("class", "rdxtooltip")               
.style("opacity", 0)
.style("z-index", 999999);

var stresstooltip = d3.select("body").append("div")   
.attr("class", "stresstooltip")               
.style("opacity", 0)
.style("z-index", 999999);

var sleeptooltip = d3.select("body").append("div")   
.attr("class", "rdxsleeptip")               
.style("opacity", 0)
.style("z-index", 999999);


redoxsvg.append("defs").append("clipPath")
.attr("id", "ctxclip")
.append("rect")
.attr("id", "ctxcliprect")
.attr("width", width)
.attr("height", ctx_height)
.attr("rx", 5)
.attr("ry",5);

redoxsvg.append("defs").append("clipPath")
.attr("id", "rdxclip")
.append("rect")
.attr("id", "rdxcliprect")
.attr("width", width)
.attr("height", height + margins.top);

redoxsvg.append("defs").append("clipPath")
.attr("id", "rdxdangerclip")
.append("rect")
.attr("id", "rdxcliprect")
.attr("width", width)
.attr("height", height)
 .attr("rx", 15)
 .attr("ry",15);


nrgsvg.append("defs").append("clipPath")
.attr("id", "nrgcliprect")
.append("rect")
.attr("id", "nrgcliprect")
.attr("width", 100)
.attr("height", 20);

muscsvg.append("defs").append("clipPath")
.attr("id", "musccliprect")
.append("rect")
.attr("id", "musccliprect")
.attr("width", 100)
.attr("height", 20);

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "greenbottom")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "green");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "amberbottom")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "orange");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "redbottom")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "red");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "undefbottom")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "#f4f2f1");
grad.append("stop").attr("offset", "50%").style("stop-color", "#f4f2f1").style("stop-opacity", 0);

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "greentop")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);
grad.append("stop").attr("offset", "50%").style("stop-color", "green");

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "ambertop")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);
grad.append("stop").attr("offset", "50%").style("stop-color", "orange");

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "redtop")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);
grad.append("stop").attr("offset", "50%").style("stop-color", "red");

var grad = redoxsvg.append("defs").append("linearGradient").attr("id", "undeftop")
.attr("x1", "0%").attr("x2", "0%").attr("y1", "100%").attr("y2", "0%");
grad.append("stop").attr("offset", "50%").style("stop-color", "white").style("stop-opacity", 0);
grad.append("stop").attr("offset", "50%").style("stop-color", "white");





var redoxctx = redoxsvg.append("g")
.attr("class", "redoxctx")
.attr("transform", "translate(" + margins.left + "," + "0" + ")");

var redoxfocus = redoxsvg.append("g")
.attr("class", "redoxfocus")
.attr("transform", "translate(" + margins.left + "," + (margins.top)  + ")");

var context = redoxsvg.append("g")
.attr("class", "contextarea")
.attr("transform", "translate(" + margins.left + "," + 5 + ")");

xcontext.domain([jan2016, fourMonthsahead]);
ycontext.domain([0, 1500]);
xfocus.domain(xcontext.domain());

var weeksarray = [];


var redox = d3.csv('@routes.Application.getRedoxCSV(player.playernumber)', function(error3, data3) {

data3.forEach(function(d, i) {
	
	 //replacing proxy characters for commas, because the commas corrupt the csv file formatting
	 for(var y in d){
		 d[y] = d[y].replace("§", ",");
	 }
	
	d.TIME_KEY = +d.TEST_TIME;
	d.TEST_TIME = new Date(+d.TEST_TIME);
	d.DEFENCE = +d.DEFENCE;d.DEFENCE_CDT = +d.DEFENCE_CDT;d.DEFENCE_INC = +d.DEFENCE_INC;
	d.STRESS = +d.STRESS;d.STRESS_CDT = +d.STRESS_CDT;d.STRESS_INC = +d.STRESS_INC;
	d.EnergyLevel = +d.EnergyLevel;
	d.NOTES = d.NOTES;
	

	
});

if(rdxval < 0) { rdxval = data3.length -1;}


var mindate = d3.min(data3, function(d) { return d.TIME_KEY;})
var maxdate = d3.max(data3, function(d) { return d.TIME_KEY;})
var aweek = 7*24*60*60*1000;
for(var i = mindate; i < maxdate; i=i+aweek){
	weeksarray.push(i);
}


yfocus2.domain([0 , 4]);

d3.select("#redoxanswersrow").attr("width", width);


redoxctx.append("rect").attr("class", "rdxbackgroundrect").attr("width", width).attr("height", height + margins.top);
nrgsvg.append("rect").attr("class", "nrgbackgroundrect").attr("width", 100).attr("height", 20);
muscsvg.append("rect").attr("class", "muscbackgroundrect").attr("width", 100).attr("height", 20);

drawRedox(data3);
drawRedoxButtons(data3);

}); // end redox loader


function drawRedox(data3) {
	
	context.append("rect").attr("class", "ctxlinerect").attr("width", width).attr("height", 20)
		.attr("transform", "translate(0," + 20 + ")");
	
	context.append("g").attr("class", "axis axis--x").attr("transform", "translate(0," + 20 + ")").call(xAxis2);
	
	context.append("g").attr("class", "CTXGROUP")
		.attr("transform", "translate(0," + 20 + ")")
		.selectAll().data(data3).enter()
		.append("circle").attr("class", "CTXhighlight").attr("id", "CTXhighlight").attr("r", 6)
		.style("fill", "grey")
		.style("stroke", "grey")
		.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", 10);
	
	
	
context.append("g")
.attr("transform", "translate(0," + 20 + ")")
.attr("class", "brush").call(brush) .call(brush.move, xcontext.range());
context.select(".brush").append("rect").attr("class", "leftbookend").attr("width", xl).attr("height", 20);
context.select(".brush").append("rect").attr("class", "rightbookend").attr("width", width).attr("height", 20);



// the weekly interval circles
redoxctx.append("g")
.attr("class", "CTXGROUP")
.selectAll().data(weeksarray).enter()
.append("circle").attr("class", "CTXweeklycircles")
.attr("r", 5)
.attr("cx", function(d) { return xfocus(d); })
.attr("cy", 95)
.on("mouseover", function(d) {
	rdxtooltip.transition().duration(200)
		.style("opacity", 0.9).style("color", "grey").style("background", "#f4f2f1").style("border-color", "grey");
	rdxtooltip .html("Weekly interval")
		.style("left", (d3.event.pageX - 50) + "px").style("top", (d3.event.pageY -20) + "px");
})
.on("mouseout", function(d) {       
	rdxtooltip.transition().duration(500).style("opacity", 0);
})


redoxctx.append("g").attr("class", "CTXGROUP").selectAll().data(data3).enter()
.append("text").attr("class", "CTXlabel").attr("id", "CTXlabel")
	//.style("fill", "none")
	.style("font-family", "Helvetica Neue,Helvetica,Arial,sans-serif")
	.style("font-size", 11)
	.style("stroke", "black")
	.style("stroke-width", 0.4)
.attr("x", function(d) { return xfocus(d.TEST_TIME) - 20; })
.attr("y", 65)
.text(function (d) { return d3.timeFormat("%b %d")(d.TEST_TIME);});


redoxctx.append("g").attr("class", "CTXGROUP").selectAll().data(data3).enter()
.append("circle").attr("class", "STRESSCTX").attr("id", "STRESSCTX").attr("r", 20)
.style("fill", function(d) { 
	//if(d.STRESS_INC > 0) {
		var diff = Math.abs(d.STRESS_CDT - d.DEFENCE_CDT);
		var tenpercent = diff * amberzone;
		
			if (d.STRESS >= d.STRESS_CDT) { return "url(#redtop)";
			} else { 
				if(d.STRESS >= (d.STRESS_CDT - tenpercent)){ return "url(#ambertop)";
				} else { return "url(#greentop)"; }
			}
		
	//}else { return "#FBFBFB"; }
	})
.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", 95);



redoxctx.append("g").attr("class", "CTXGROUP").selectAll().data(data3).enter()
.append("circle").attr("class", "DEFENCECTX").attr("id", "DEFENCECTX").attr("r", 20)
	.style("fill", function(d) { 
	//if(d.DEFENCE_INC > 0) {
		var diff = Math.abs(d.STRESS_CDT - d.DEFENCE_CDT);
		var tenpercent = diff * amberzone;
		if(d.DEFENCE === 0.0){
			return "url(#undefbottom)";
		}else{
			if (d.DEFENCE <= d.DEFENCE_CDT) { return "url(#redbottom)";
			} else { if(d.DEFENCE <= (d.DEFENCE_CDT + tenpercent)){ return "url(#amberbottom)";
						} else { return "url(#greenbottom)"; }
			}
		}
		
			
		
	//} else { return "#FBFBFB"; }
	})
.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", 95)
.on("click", function(d,i) {
	
	d3.selectAll(".verticallines").style("stroke", "#e6e6e6").style("stroke-width", "1px");
	d3.selectAll(".CTXcircles").style("stroke", "#e6e6e6").style("stroke-width", "1px");
	d3.selectAll(".UPtriangles").style("fill", "none").style("stroke-width", "1px");
	
	d3.select("#vert" + d.TIME_KEY).style("stroke", "white").style("stroke-width", "5px");
	d3.select("#CTXcircle" + d.TIME_KEY).style("stroke", "white").style("stroke-width", "3px");
	d3.select("#UPtriangle" + d.TIME_KEY).style("fill", "white").style("stroke-width", "1px");
	
	var currentleft = xfocus.domain()[0].getTime();
	var currentright = xfocus.domain()[1].getTime();
	var halfwidth = (currentright - currentleft)/2;
	
	var newleftdate = new Date(d.TIME_KEY - halfwidth);
	var newrightdate = new Date(d.TIME_KEY + halfwidth);
	
	xcontext.domain([jan2016, fourMonthsahead]);
	xfocus.domain(xcontext.domain());
	
	xl = xfocus(newleftdate.getTime());
	xr = xfocus(newrightdate.getTime());
	
	redoxsvg.select(".zoom").transition().ease(d3.easeCubic).duration(1000)
	.call(zoom.transform, d3.zoomIdentity.scale(width / (xr - xl)).translate(-xl, 0));
	

	rdxval = i;
	document.cookie="rdxval="+ i +";";
	
	updateanswerfields(d);
		
	});





redoxfocus.append("path").datum(data3).attr("class", "rdxdangerzone").attr("id", "rdxdangerzone").attr("d", dangerarea(height));
redoxfocus.append("path").datum(data3).attr("class", "rdxsafezone").attr("id", "rdxsafezone").attr("d", safearea);
redoxfocus.append("path").datum(data3).attr("class", "rdxamberzone").attr("id", "rdxdefenceamberzone").attr("d", defenceamberarea);
redoxfocus.append("path").datum(data3).attr("class", "rdxamberzone").attr("id", "rdxstressamberzone").attr("d", stressamberarea);
redoxfocus.append("g").attr("class", "Rdxaxis Rdxaxis--y").call(yAxisRdx);
// removing the zero tick from the y-axis
redoxfocus.selectAll(".tick").each(function(d) {if(d===0) {this.remove();}});

redoxfocus.selectAll(".tick text")  // select all the text elements for the xaxis
.attr("transform", function(d) {
   return "translate(" + 0 + "," + 5 + ")";
});






redoxctx.append("g")
.attr("class", "CTXGROUP")
.selectAll().data(data3).enter()
.append("circle").attr("class", "CTXcircles")
.attr("id", function(d) { return "CTXcircle" + d.TIME_KEY; }) 
.attr("r", 21)
.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", 95);

redoxfocus.append("g")
.attr("transform", "translate(0," + -25 + ")")
.selectAll('.verticallines').data(data3).enter()
.append("line").attr("class", "verticallines")
.attr("id", function(d) { return "vert" + d.TIME_KEY; }) 
.attr("x1", function(d) { return xfocus(d.TEST_TIME);})
.attr("y1", height + 40)
.attr("x2", function(d) { return xfocus(d.TEST_TIME);})
.attr("y2", 0);

// adding the triangles along the bottom
redoxfocus.append("g")
.selectAll('.highlighttriangles').data(data3).enter()
.append("path").attr("class", "UPtriangles")
.attr("id", function(d) { return "UPtriangle" + d.TIME_KEY; })

.attr("d", d3.symbol().type(d3.symbolTriangle).size(200))
.attr("transform", function(d) { return "translate(" + xfocus(d.TEST_TIME) + "," + (height -6)  + ")"});



redoxfocus.append("rect").attr("class", "zoom").attr("width", width).attr("height", height + margins.top).call(zoom);


redoxfocus.append("path").datum(data3).attr("class", "defenceline").attr("id", "defenceline").attr("d", defenceline);
redoxfocus.append("path").datum(data3).attr("class", "defenceadjline").attr("id", "defenceadjline").attr("d", defenceadjline);


// stress(STRESS)
redoxfocus.append("path").datum(data3).attr("class", "stressline").attr("id", "stressline").attr("d", stressline);
redoxfocus.append("path").datum(data3).attr("class", "stressadjline").attr("id", "stressadjline").attr("d", stressadjline);


redoxfocus.append("g").attr("class", "STRESSGROUP").selectAll().data(data3).enter()
.append("circle").attr("class", "STRESS").attr("id", "STRESS").attr("r", 10)
.style("fill", function(d) { 
	if(d.STRESS_INC > 0) {
		var diff = Math.abs(d.STRESS_CDT - d.DEFENCE_CDT);
		var tenpercent = diff * amberzone;
		if (d.STRESS >= d.STRESS_CDT) { return "red";
		} else {
			if(d.STRESS >= (d.STRESS_CDT - tenpercent)){ return "orange";
			} else { return "green"; }
		}
	}else { return "#FBFBFB"; }
	})
.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", function(d) { return yfocus2(d.STRESS); })
	
@restrict(roles = allOfGroup("redoxvalues")) {
	.on("mouseover", function(d) {
		rdxtooltip.transition().duration(200)
			.style("opacity", 0.9).style("color", "purple").style("background", "#FEE6FF").style("border-color", "purple")
			.style("left", (d3.event.pageX - 50) + "px").style("top", (d3.event.pageY -50) + "px");
		rdxtooltip .html("Stress : " + (parseFloat(d.STRESS)));
		})
	.on("mouseout", function(d) {       
		rdxtooltip.transition().duration(500).style("opacity", 0)
		.style("left", "-50px").style("top", "0px");
	})
	
}

@restrict(roles = allOfGroup("redoxtoggle")) {
		.on("click", function(d) {
			linktip
			.style("opacity", 0).style("color", "none").style("background", "rgba(128,0,128, 0.1)").style("border-color", "none").style("z-index", 99999);
			linktip .html("<form id='fordtoggle' action='@routes.Application.updateRedoxToggleState(player.playernumber, category)' method='POST'  enctype='multipart/form-data' >"
				+"<input id='timekey' type='text' name='timekey' value='"+d.TIME_KEY+"'/>"
				+"<button>Toggle</button></form> ") 
			.style("left", "200px").style("top", "50px");
			document.getElementById("fordtoggle").submit();
		})
}
;


//Defence(DEFENCE)
redoxfocus.append("g").attr("class", "DEFENCEGROUP").selectAll().data(data3).enter()
.filter(function(d){ return d.DEFENCE > 0.01;})
.append("circle").attr("class", "DEFENCE").attr("id", "DEFENCE").attr("r", 10)
.style("fill", function(d) { 
	if(d.DEFENCE_INC > 0) { 
		var diff = Math.abs(d.STRESS_CDT - d.DEFENCE_CDT);
		var tenpercent = diff * amberzone; 
		if (d.DEFENCE <= d.DEFENCE_CDT) { return "red";
		} else {
			if(d.DEFENCE <= (d.DEFENCE_CDT + tenpercent)){ return "orange";
			} else { return "green"; }
		}
	}else { return "#FBFBFB"; }
}) 
.attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", function(d) { return yfocus2(d.DEFENCE); })


@restrict(roles = allOfGroup("redoxvalues")) {
	.on("mouseover", function(d) {
		rdxtooltip.transition().duration(200)
				.style("opacity", 0.9).style("color", "blue").style("background", "#D0D8FF").style("border-color", "blue")
				.style("left", (d3.event.pageX - 50) + "px").style("top", (d3.event.pageY +30) + "px");
		rdxtooltip .html("Defence : " + (parseFloat(d.DEFENCE)))
		
				
			})
		.on("mouseout", function(d) {       
			rdxtooltip.transition().duration(500).style("opacity", 0)
			.style("left", "-50px").style("top", "0px");
		})
}

@restrict(roles = allOfGroup("redoxtoggle")) {

	.on("click", function(d) {
		linktip.style("opacity", 0).style("color", "none").style("background", "rgba(128,0,128, 0.1)").style("border-color", "none").style("z-index", 99999);
		linktip .html("<form id='fordtoggle' action='@routes.Application.updateRedoxToggleState(player.playernumber, category)' method='POST'  enctype='multipart/form-data' >"
			+"<input id='timekey' type='text' name='timekey' value='"+d.TIME_KEY+"'/>"
			+"<button>Toggle</button></form> ") 
		.style("left", "200px").style("top", "50px");
		document.getElementById("fordtoggle").submit();
	})
}
;





d3.select("#nrgsvg").append("rect").attr("class", "nrgforegroundrect");
d3.select("#nrgsvg").append("text").attr("id", "nrgtext").attr("transform", "translate(5,15)").style("font-size", "12px");//.text("howdy");

d3.select("#muscsvg").append("rect").attr("class", "muscforegroundrect");
d3.select("#muscsvg").append("text").attr("id", "musctext").attr("transform", "translate(5,15)").style("font-size", "12px");//.text("howdy");



updateanswerfields(data3[data3.length -1]);

//sets the viewport to the last set in the cookie
redoxsvg.select(".zoom").call(zoom.transform, d3.zoomIdentity.scale(width / (xr - xl)).translate(-xl, 0));

function updateanswerfields(d) {
	
	d3.select("#rdxid").attr("value", function(){ return d.id;});
	
	// highlighting the selected data point
	d3.select("#vert" + d.TIME_KEY).style("stroke", "white").style("stroke-width", "5px");
	d3.select("#CTXcircle" + d.TIME_KEY).style("stroke", "white").style("stroke-width", "3px");
	d3.select("#UPtriangle" + d.TIME_KEY).style("fill", "white").style("stroke-width", "1px");
	
	// reset the fields first
	d3.select("#EATENVALUE").attr("class", "").style("font-size", "11px");
	d3.select("#EATENVALUE").text("");
	d3.select("#TRAINEDVALUE").attr("class", "").style("font-size", "11px");
	d3.select("#TRAINEDVALUE").text("");
	
	d3.select("#ILLVALUE").attr("class", "").style("font-size", "11px");
	d3.select("#ILLVALUE").text("");
	
	
	d3.select("#INJUREDVALUE").attr("class", "").style("font-size", "11px");
	d3.select("#INJUREDVALUE").text("");
	
	
	if(d.AteToday === "null") { 
		//d3.select("#EATENVALUE").attr("class", "glyphicon glyphicon-question-sign");
		d3.select("#EATENVALUE").text(function() { return "Not Known"});
	} 
	if(d.AteToday === "Yes" || d.AteToday === "yes") { 
		d3.select("#EATENVALUE").attr("class","glyphicon glyphicon-exclamation-sign").style("font-size", "14px");
		d3.select("#EATENVALUE").append('strong').style("color", "black").text(function() { return "No"});
		
	}
	if(d.AteToday === "No" || d.AteToday === "no") { 
		//d3.select("#EATENVALUE").attr("class", "glyphicon glyphicon-remove");
		d3.select("#EATENVALUE").text(function() { return "Yes"});
		
	}
	
	
	// note that trained today has been inverted to rested, hence the opposite interpretation from AteToday
	if(d.TrainedToday === "null") { 
		d3.select("#TRAINEDVALUE").text(function() { return "Not Known"});
	} 
	if(d.TrainedToday === "Yes" || d.TrainedToday === "yes") { 
		
		d3.select("#TRAINEDVALUE").attr("class","glyphicon glyphicon-exclamation-sign").style("font-size", "14px");
		d3.select("#TRAINEDVALUE").append('strong').style("color", "black").text(function() { return "No"});
	}
	if(d.TrainedToday === "No" | d.TrainedToday === "no") { 
		//d3.select("#TRAINEDVALUE").attr("class", "glyphicon glyphicon-remove");
		d3.select("#TRAINEDVALUE").text(function() { return "Yes"});
	}
	
	if(d.Ill === "null" | d.Ill === "") { 
		//d3.select("#ILLVALUE").attr("class", "glyphicon glyphicon-question-sign");
		d3.select("#ILLVALUE").text(function() { return "Not Known"});
	} 
	if(d.Ill === "Yes" || d.Ill === "yes") { 
		d3.select("#ILLVALUE").attr("class","glyphicon glyphicon-exclamation-sign").style("font-size", "14px");
		d3.select("#ILLVALUE").append('strong').style("color", "black").text(function() { return "Yes"});
	}
	if(d.Ill === "No" | d.Ill === "no") { 
		d3.select("#ILLVALUE").text(function() { return "No"});
	}
	
	if(d.Injured === "null" | d.Injured === "") { 
		d3.select("#INJUREDVALUE").text(function() { return "Not Known"});
	} 
	if(d.Injured === "Yes" || d.Injured === "yes") { 
		//d3.select("#INJUREDVALUE").attr("class","glyphicon glyphicon-exclamation-sign");
		d3.select("#INJUREDVALUE").attr("class","glyphicon glyphicon-exclamation-sign").style("font-size", "14px");
		d3.select("#INJUREDVALUE").append('strong').style("color", "black").text(function() { return "Yes"});
	}
	if(d.Injured === "No" | d.Injured === "no") { 
		d3.select("#INJUREDVALUE").text(function() { return "No"});
	}
	
	//resetting
	d3.selectAll(".testauto").style("height", "0px");
	//d3.select("#FEVERSURROUND").style("height", "0px");
	d3.select("#FEVER").text(function() { return ""});
	d3.select("#FEVERVALUE").text(function() { return ""});
	//d3.select("#COLDSORESURROUND").style("height", "0px");
	d3.select("#COLDSORE").text(function() { return ""});
	d3.select("#COLDSOREVALUE").text(function() { return ""});
	//d3.select("#HEADACHESURROUND").style("height", "0px");
	d3.select("#HEADACHE").text(function() { return ""});
	d3.select("#HEADACHEVALUE").text(function() { return ""});
	d3.select("#JMACHE").text(function() { return ""});
	d3.select("#JMACHEVALUE").text(function() { return ""});
	d3.select("#DIARRHEA").text(function() { return ""});
	d3.select("#DIARRHEAVALUE").text(function() { return ""});
	d3.select("#OTHER").text(function() { return ""});
	d3.select("#OTHERVALUE").text(function() { return ""});
	//PRACTICEVALUE
	//ExerciseGymYesterday
	if(d.Fever !== "") {
		d3.select("#FEVER").text(function() { return "Fever"});
		d3.select("#FEVERVALUE").text(function() { return d.Fever});
		//FEVERSURROUND
		d3.select("#FEVERSURROUND").style("height", "20px");
	} 
	
	if(d.SoreThroat !== "") {
		d3.select("#COLDSORE").text(function() { return "Cold/Sore Throat"});
		d3.select("#COLDSOREVALUE").text(function() { return d.SoreThroat});
		d3.select("#COLDSORESURROUND").style("height", "20px");
		//d3.select("#SYMPTOMS").attr("height", 85);
	} 
	
	if(d.Headache !== "") {
		d3.select("#HEADACHE").text(function() { return "Headache"});
		d3.select("#HEADACHEVALUE").text(function() { return d.Headache});
		d3.select("#HEADACHESURROUND").style("height", "20px");
		//d3.select("#SYMPTOMS").attr("height", 105);
	} 
	
	if(d.JointorMuscleAche !== "") {
		d3.select("#JMACHE").text(function() { return "Joint/Muscle Ache"});
		d3.select("#JMACHEVALUE").text(function() { return d.JointorMuscleAche});
		d3.select("#JMACHESURROUND").style("height", "20px");
	} 
	
	if(d.Diarrhea !== "") {
		d3.select("#DIARRHEA").text(function() { return "Diarrhea/Sickness"});
		d3.select("#DIARRHEAVALUE").text(function() { return d.Diarrhea});
		d3.select("#DIARRHEASURROUND").style("height", "20px");
	} 
	
	if(d.Other !== "") {
		d3.select("#OTHER").text(function() { return "Other"});
		d3.select("#OTHERVALUE").text(function() { return d.Other});
		d3.select("#OTHERSURROUND").style("height", "20px");
	} 
	
	
	
	
	//d3.select("#ACTIVITIESVALUE").text(function() {return d.Exercises});
	var activitiesnotes = d.Exercises.split(';');
	d3.selectAll(".ACTIVITIES").remove();
	for (var i = 0; i < activitiesnotes.length; i++){
		if(activitiesnotes[i] !== ""){
			d3.select("#ACTIVITIESVALUE").append("li").attr("class", "ACTIVITIES").text(function() {
				return activitiesnotes[i];
			});
		}
	}
	
	
	
	
	d3.select("#TESTERNOTESVALUE").text(function() {
		
		var replaceChars = d.testernotes.replace(/§/gi, ",");
			//txt += dietarray[i].replace(/§/gi, ",") + "<br><br>";
		
		return replaceChars});
	//
	var nrgcolorarray = ["#ffabbe", "#ffe0a8", "#71f2e4", "#68f7a3", "#deff8a"];
	//var nrgcolorarray = ["#deff8a", "#68f7a3", "#71f2e4", "#ffe0a8", "#ffabbe"];
	//var nrgcolorarray = ["#ff0202", "#f00", "#ffa100", "#008900", "#008900"];
	d3.select(".nrgforegroundrect")
	.attr("width", function() { return d.EnergyLevel > 0 ? (d.EnergyLevel * 100)/5 + 20 : 20; })
	.attr("height", 20)
	.style( "fill", nrgcolorarray[Math.ceil(parseFloat(d.EnergyLevel))]  );
	
	d3.select(".nrgbackgroundrect").style( "stroke", nrgcolorarray[Math.ceil(parseFloat(d.EnergyLevel))]  );
	
	var nrgtextarray = ["Very low", "Low", "OK", "Good", "High" ];
	d3.select("#nrgtext").text(  nrgtextarray[Math.ceil(parseFloat(d.EnergyLevel))]  );
	

	
	
	var musccolorarray = ["#deff8a", "#68f7a3", "#71f2e4", "#ffe0a8", "#ffabbe"];
	d3.select(".muscforegroundrect")
	.attr("width", function() { return d.MuscleSoreness > 0 ? (d.MuscleSoreness * 100)/5 + 20 : 20; })
	.attr("height", 20)
	.style( "fill", musccolorarray[Math.ceil(parseFloat(d.MuscleSoreness))]  );
	
	d3.select(".muscbackgroundrect").style( "stroke", musccolorarray[Math.ceil(parseFloat(d.MuscleSoreness))]  );
	
	var musctextarray = ["Feel great", "Not sore", "Average", "Sore", "Very sore"];
	d3.select("#musctext").text(  musctextarray[Math.ceil(parseFloat(d.MuscleSoreness))]  );

	
	//d3.select(".nrgforegroundrect").style( "fill", musccolorarray[Math.ceil(parseFloat(d.MuscleSoreness))]  );
	
	
// 	if(d.MuscleSoreness > 0 && d.MuscleSoreness >= 4) {
// 		d3.select("#MUSCSOREICON").attr("src", function(d){ return "/assets/images/emoticons/happy.png"; })
// 	}
// 	if(d.MuscleSoreness > 1 && d.MuscleSoreness >= 3) {
// 		d3.select("#MUSCSOREICON").attr("src", function(d){ return "/assets/images/emoticons/smile.png"; })
// 	}
// 	if(d.MuscleSoreness > 2 && d.MuscleSoreness >= 2) {
// 		d3.select("#MUSCSOREICON").attr("src", function(d){ return "/assets/images/emoticons/neutral.png"; })
// 	}
// 	if(d.MuscleSoreness > 3 && d.MuscleSoreness >= 1) {
// 		d3.select("#MUSCSOREICON").attr("src", function(d){ return "/assets/images/emoticons/sad.png"; })
// 	}
// 	if(d.MuscleSoreness > 4 && d.MuscleSoreness >= 0) {
// 		d3.select("#MUSCSOREICON").attr("src", function(d){ return "/assets/images/emoticons/crying.png"; })
// 	}
	
	var resultsarray = d.ResultShow.split(';');
	d3.selectAll(".resultstexts").remove();
	for (var i = 0; i < resultsarray.length; i++){
		d3.select("#RESULTSHOW").append("p").attr("class", "resultstexts").text(function() {
			return resultsarray[i];
		});	
	}
	

	
	var ssnotes = d.NOTES.split(';');
	var ss = d.SS.split(';');
	d3.selectAll(".rdxcommentrow").remove();
	for (var i = 0; i < ssnotes.length; i++){
		
		if(ssnotes[i] !== "") {
			
			var top = d3.select("#scientistcomment")
			.append("div")
			.attr("class", "row rdxcommentrow");
			
			var first = top.append("div")
			.attr("class", "col-xs-2 col-sm-2 col-md-2 col-lg-2")
			.text(function() { return ss[i]; });
			
			top.append("div")
			.attr("class", "col-xs-10 col-sm-10 col-md-10 col-lg-10 rdxcomment")
			
			.text(function() {
				//console.log("it is "+actionsarray[i]+":");
				return ssnotes[i];
			});
		
		}
			
	}


	
	
// 	var ssnotes = d.NOTES.split(';');
// 	d3.selectAll(".ORRECOSSTEXT").remove();
// 	for (var i = 0; i < ssnotes.length; i++){
// 		if(ssnotes[i] !== ""){
// 			d3.select("#ORRECOSSTEXT").append("li").attr("class", "ORRECOSSTEXT").text(function() {
// 				return ssnotes[i];
// 			});
// 		}
// 	}
	
// 	var ss = d.SS.split(';');
// 	d3.selectAll(".ORRECOSSNAME").remove();
// 	for (var i = 0; i < ss.length; i++){
// 		if(ss[i] !== ""){
// 			d3.select("#ORRECOSSNAME").append("li").attr("class", "ORRECOSSNAME").text(function() {
// 				return ss[i];
// 			});
// 		}
// 	}
	
	
	
	//d3.select("#ORRECOSSNAME").text(function() { return "Sports Scientist"; });
	
	var potoutsarray = d.POTOUT.split(';');
	d3.selectAll(".potentialoutcomestext").remove();
	for (var i = 0; i < potoutsarray.length; i++){
		d3.select("#POTOUTS").append("p").attr("class", "potentialoutcomestext").text(function() {
			return potoutsarray[i];
		});
			
	}
	
	

	
	
	var actionsarray = d.ACTION.split(';');
	d3.selectAll(".actionrows").remove();
	for (var i = 0; i < actionsarray.length; i++){
		
		if(actionsarray[i] !== "") {
			
			var top = d3.select("#ACTIONS")
			.append("div")
			.attr("class", "row actionrows");
			
			var mid = top.append("div")
			.attr("class", "col-xs-1 col-sm-1 col-md-1 col-lg-1")
			.attr("id", "ACTIONIMG")
			.append("img")
			.attr("class", "img-responsive orrecobullet")
			.attr("src", '@routes.Assets.at("images/graphicon.png")');
			
			top.append("div")
			.attr("class", "col-xs-11 col-sm-11 col-md-11 col-lg-11 actions")
			
			.text(function() {
				//console.log("it is "+actionsarray[i]+":");
				return actionsarray[i];
			});
		
		}
			
	}
	
	var dietarray = d.DietAdvice.split(';');
	
	if(dietarray[0] ===""){
		
		d3.selectAll("#dietsvg").selectAll("path").attr("class", "stdiet0");
		d3.selectAll("#dietsvg")
		.on("click", null);
	} else {

		d3.selectAll("#dietsvg").selectAll("path").attr("class", "stdiet1");
		d3.selectAll("#dietsvg")
		.on("click", function(d) {
			
			var w = (width + margins.left + margins.right) * 0.15;
			
			sleeptooltip.transition().duration(200)
				.style("opacity", 1).style("color", "grey").style("background", "white").style("border-color", "grey");
			sleeptooltip .html( function () {
				var txt ="";
				for (var i = 0; i < dietarray.length; i++){
					txt += dietarray[i].replace(/§/gi, ",") + "<br><br>";
				}
				//console.log("txt is "+ txt);
				return txt;
			})
				.style("left", (d3.event.pageX - w) + "px").style("top", (d3.event.pageY + 50) + "px");
			})
		.on("mouseout", function(d) {       
			sleeptooltip.transition().duration(500).style("opacity", 0)
		})
	}
	

	
	
	
	
	var trainloadarray = d.TrainingLoadAdvice.split(';');
	
	if(trainloadarray[0] ===""){
		d3.selectAll("#trainloadsvg").selectAll("path").attr("class", "sttrain00");
		d3.selectAll("#trainloadsvg")
		.on("click", null);
		
	} else {
		d3.selectAll("#trainloadsvg").selectAll("path").attr("class", "sttrain01");
		d3.selectAll("#trainloadsvg")
		.on("click", function(d) {
			
			var w = (width + margins.left + margins.right) * 0.15;
			sleeptooltip.transition().duration(200)
				.style("opacity", 1).style("color", "grey").style("background", "white").style("border-color", "grey");
			sleeptooltip .html( function () {
				var txt ="";
				for (var i = 0; i < trainloadarray.length; i++){
					txt += trainloadarray[i].replace(/§/gi, ",") + "<br><br>";
				}
				return txt;
			})
				.style("left", (d3.event.pageX - w) + "px").style("top", (d3.event.pageY + 50) + "px");
			})
		.on("mouseout", function(d) {       
			sleeptooltip.transition().duration(500).style("opacity", 0)
		})
	}
	

	
	
	
	
	var sleeparray = d.Sleepadvice.split(';');

	if(sleeparray[0] ===""){
		d3.selectAll("#sleepsvg").selectAll("path").attr("class", "stsleep0");
		d3.selectAll("#sleepsvg").selectAll("polygon").attr("class", "stsleep0");
		d3.selectAll("#sleepsvg")
		.on("click", null);
		
	} else {
	
		d3.selectAll("#sleepsvg").selectAll("path").attr("class", "stsleep1");
		d3.selectAll("#sleepsvg").selectAll("polygon").attr("class", "stsleep1");
		d3.selectAll("#sleepsvg")
		.on("click", function(d) {

			var w = (width + margins.left + margins.right) * 0.15;
			sleeptooltip.transition().duration(200)
				.style("opacity", 1).style("color", "grey").style("background", "white").style("border-color", "grey");
			sleeptooltip .html( function () {
				var txt ="";
				for (var i = 0; i < sleeparray.length; i++){
					txt += sleeparray[i].replace(/§/gi, ",") + "<br><br>";
				}
				//console.log(txt);
				return txt;
			})
				.style("left", (d3.event.pageX - w) + "px").style("top", (d3.event.pageY + 50) + "px");
			})
		.on("mouseout", function(d) {       
			sleeptooltip.transition().duration(500).style("opacity", 0)
		})
	}
	
}










//redoxsvg.select(".zoom").call(zoom.transform, d3.zoomIdentity.scale(width / (xr - xl)).translate(-xl, 0));


} // end drawRedox()


function drawRedoxButtons(data3) {
var RDXFOCUS_showhide_button = redoxsvg.append("g").attr("class", "RDXDATA_Button")
.attr("transform", "translate("+30 + "," + 60 + ")");

RDXFOCUS_showhide_button.append("text").attr("id", "rdxbutton").attr("x", 8).attr("y", 15).attr("fill", "#464640")
	.text(function() {
	return RDXview_state? "-" : "+";
	});
	

var textWidth = RDXFOCUS_showhide_button.select("text").node().getBBox().width;
			
RDXFOCUS_showhide_button.append("rect").attr("rx", 4).attr("ry", 4)
	.attr("width", textWidth + 15).attr("height", 18)
	.attr("class", "showhidebuttons").attr("id", "RDXDATA_Button") 
	.on("click", function(){

	//showhideGPS focus panel()
	RDXview_state = !RDXview_state;
	document.cookie="rdxviewstate="+ RDXview_state +";";
	//d3.select(".showhidebuttons").style("stroke-width", RDXview_state ? 2 : 1);
	
	if(RDXview_state){
		redoxsvg.transition(d3.easeCubic).duration(1000).attr("height", redoxpane_h_open);
	} else {
		redoxsvg.transition(d3.easeCubic).duration(1000).attr("height", redoxpane_h_closed);
	}
	
	d3.selectAll("#rdxbutton").text(function(d) {return RDXview_state ? "-" : "+";});        	
	});


} // end drawRedoxButtons






function redrawRedox() {

redoxfocus.selectAll("#defenceline").attr("d", defenceline);
redoxfocus.selectAll("#defenceadjline").attr("d", defenceadjline);
redoxfocus.selectAll("#DEFENCE").attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", function(d) { return yfocus2(d.DEFENCE); });
redoxfocus.selectAll("#stressline").attr("d", stressline);
redoxfocus.selectAll("#stressadjline").attr("d", stressadjline);
redoxfocus.selectAll("#STRESS").attr("cx", function(d) { return xfocus(d.TEST_TIME); }).attr("cy", function(d) { return yfocus2(d.STRESS); });


redoxfocus.selectAll("#rdxdangerzone").attr("d", dangerarea(height));
redoxfocus.selectAll("#rdxdefenceamberzone").attr("d", defenceamberarea);
redoxfocus.selectAll("#rdxstressamberzone").attr("d", stressamberarea);
redoxfocus.selectAll("#rdxsafezone").attr("d", safearea);

redoxfocus.selectAll(".verticallines").attr("x1", function(d) { return xfocus(d.TEST_TIME);}).attr("x2", function(d) { return xfocus(d.TEST_TIME);});
redoxfocus.selectAll('.UPtriangles').attr("transform", function(d) { return "translate(" + xfocus(d.TEST_TIME) + "," + (height -6) + ")"});

redoxctx.selectAll("#STRESSCTX").attr("cx", function(d) { return xfocus(d.TEST_TIME); });
redoxctx.selectAll("#DEFENCECTX").attr("cx", function(d) { return xfocus(d.TEST_TIME); });
redoxctx.selectAll(".CTXcircles").attr("cx", function(d) { return xfocus(d.TEST_TIME); });
redoxctx.selectAll("#CTXlabel").attr("x", function(d) { return xfocus(d.TEST_TIME) - 20; });
redoxctx.selectAll(".CTXweeklycircles").attr("cx", function(d) { return xfocus(d); });

redoxsvg.attr("height", function(){ return RDXview_state? redoxpane_h_open : redoxpane_h_closed});

}  //end redrawRedox()






function redrawChart() {

//datatip.transition().duration(200).style("opacity", 0);
//gametip.transition().duration(200).style("opacity", 0);

redrawRedox();


redoxfocus.select(".axis--x").call(xAxis);
} // end redrawchart






function brushed() {

//console.log("brushing");
var s = d3.event.selection || xcontext.range();

if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom") {
	//console.log("brushing and returning");
	document.cookie="xl="+ s[0] +";";
	document.cookie="xr="+ s[1] +";";
	xl = s[0];
	xr = s[1];
	return;
}
xfocus.domain(s.map(xcontext.invert, xcontext));

redrawChart();

// redoxsvg.select(".zoom").call(zoom.transform, d3.zoomIdentity
// 		  .scale(width / (s[1] - s[0]))
// 		  .translate(-s[0], 0));

context.select(".leftbookend").attr("width", s[0]);
context.select(".rightbookend").attr("x", s[1]);

} //end brushed


function zoomed() {
//console.log("zooming");
if (d3.event.sourceEvent && d3.event.sourceEvent.type === "brush") { return;}
var t = d3.event.transform;

xfocus.domain(t.rescaleX(xcontext).domain());
var n = t.rescaleX(xcontext).domain();
redrawChart();

context.select(".brush").call(brush.move, xfocus.range().map(t.invertX, t));
context.select(".leftbookend").attr("width", xcontext(n[0]));
context.select(".rightbookend").attr("x", xcontext(n[1]));
} // end zoomed




d3.select(window).on('resize', resize);
function resize() {
// update width
windowwidth = parseInt(d3.select('#main_chart').style('width'), 10);
redoxpane_h_open = Math.max(((windowHeight/8)), max_rdxsvg_h);



d3.select('#redoxsvg').attr("width", windowwidth).attr("height", redoxpane_h_open);

width = +redoxsvg.attr("width") - margins.left - margins.right,
ctx_height = +gpsdatasvg.attr("height") - context_margin.top - context_margin.bottom,
height = +redoxsvg.attr("height") - margins.top - margins.bottom;

 d3.select('#clip').attr("width", width).attr("height", height);
 d3.select('#cliprect').attr("width", width).attr("height", height);
 

xfocus.range([0, width]),
yfocus.range([height, 0]);
xcontext.range([0, width]),
ycontext.range([ctx_height, 0]);

checkcookie();


context.select(".axis--x").call(xAxis2);
redrawChart();

redoxsvg.select(".zoom").call(zoom.transform, d3.zoomIdentity
		  .scale(width / (xr - xl))
		  .translate(-xl, 0));


} // end resize



function checkcookie() {

//RDXview_state
if(document.cookie.indexOf("rdxviewstate") >= 0) {
	
	var cookiearray = document.cookie.split(';');
	
	for(var i=0; i<cookiearray.length; i++){
        if(cookiearray[i].split('=')[0].trim() === "rdxviewstate"){
        	
    		var setting = cookiearray[i].split('=')[1].trim();
    		if(setting === "true") {
    			RDXview_state = true;
    		} else {
    			RDXview_state = false;
    		}
        }
        
     }
	
} else {
	RDXview_state = true;
}

if(document.cookie.indexOf("xl") >= 0) {
	var lhs,rhs;
	var cookiearray = document.cookie.split(';');
	
	for(var i=0; i<cookiearray.length; i++){
        if(cookiearray[i].split('=')[0].trim() === "xl"){
        	
        
        	if(isNaN(cookiearray[i].split('=')[1].trim())){
        		console.log("here Nan");
        		
        		xl = threeweeksago;
        		document.cookie="xl="+ xl +";";
        	} else {
        		xl = cookiearray[i].split('=')[1].trim();
        		//console.log("not Nan");
        	}
        	
        }
        if(cookiearray[i].split('=')[0].trim() === "xr") {
        	if(isNaN(cookiearray[i].split('=')[1].trim())){
        		xr = oneweekahead;
        		document.cookie="xr="+ xr +";";
        	} else {
        		xr = cookiearray[i].split('=')[1].trim();
        	}
      	  xr = cookiearray[i].split('=')[1].trim();
        }
     }
	
} else {
	xl = threeweeksago;
	xr = oneweekahead;
}




if(document.cookie.indexOf("rdxval") >= 0) {
	
	var cookiearray = document.cookie.split(';');
	
	for(var i=0; i<cookiearray.length; i++){
        if(cookiearray[i].split('=')[0].trim() === "rdxval"){
        	
        	if(isNaN(cookiearray[i].split('=')[1].trim())){
        		console.log("rdxval is Nan");
        	} else {
        		rdxval = cookiearray[i].split('=')[1].trim();
        	}
        }
     }
	
} 


} // end checkcookie

(function ($) {
  $(document).ready(function(){

    // hide .navbar first
   //$(".navbar").hide();

    // fade in .navbar
    $(function () {
        $(window).scroll(function () {

                 // set distance user needs to scroll before we start fadeIn
            if ($(this).scrollTop() > 10) {
               // $('.navbar').fadeIn();
                $('.navbar').fadeOut();
            } else {
                //$('.navbar').fadeOut();
                $('.navbar').fadeIn();
            }
        });
    });

});
  }(jQuery));
	  
</script>
    
}